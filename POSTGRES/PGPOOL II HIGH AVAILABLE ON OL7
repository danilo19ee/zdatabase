+++++++++++++++++++++++++++++++++++++++++
+    PGPOOL II HIGH AVAILABLE ON OL7    +
+++++++++++++++++++++++++++++++++++++++++

#CLUSTER SYSTEM CONFIGURATION
MACHINE             HOSTNAME            IP               
OL7_PGPOOL2_PRIM    pgpool2_prim        192.168.1.126   
OL7_PGPOOL2_STDB1   pgpool2_stdb1       192.168.1.127
OL7_PGPOOL2_STDB2   pgpool2_stdb2       192.168.1.128

#DISABLE SELINUX AND FIREWALLD

sed -i 's/SELINUX=.*/SELINUX=disabled/' /etc/selinux/config && setenforce 0
systemctl stop firewalld && systemctl disable firewalld

#REPEAT CONFIGURATION FOR OTHER MACHINES

#CONFIGURE STATIC NETWORK
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=none
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=no
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=enp0s3
UUID=49c279da-7065-40f5-b914-176973db2a0a
DEVICE=enp0s3
ONBOOT=yes
IPADDR=192.168.1.126
PREFIX=24
GATEWAY=192.168.1.1

#REPEAT CONFIGURATION FOR OTHER MACHINES

#CONFIGURE HOSTNAME
hostnamectl 
hostnamectl set-hostname pgpool2_prim
hostnamectl --static

#REPEAT CONFIGURATION FOR OTHER MACHINES

#REPEAT CONFIGURATION FOR OTHER MACHINES

#CONFIGURE /ETC/HOSTS
vi /etc/hosts
192.168.1.126   pgpool2_prim
192.168.1.127   pgpool2_stdb1
192.168.1.128   pgpool2_stdb2

#REPEAT CONFIGURATION FOR OTHER MACHINES

#CONFIGURE DNS
vi /etc/resolv.conf
nameserver 8.8.8.8
nameserver 8.8.4.4

#REPEAT CONFIGURATION FOR OTHER MACHINES

#CONFIGURE AND INSTALL SOFTWARE POSTGRESQL
vi /etc/yum.repos.d/oracle-linux-ol7.repo

[ol7_optional_developer]
name=Developer Preview of Oracle Linux $releasever Optional ($basearch)
baseurl=https://yum.oracle.com/repo/OracleLinux/OL7/optional/developer/$basearch/
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-oracle
gpgcheck=1
enabled=1

[ol7_developer_EPEL]
name=Oracle Linux $releasever Development Packages ($basearch)
baseurl=https://yum.oracle.com/repo/OracleLinux/OL7/developer_EPEL/$basearch/
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-oracle
gpgcheck=1
enabled=1

yum install openssl-devel libtermcap-devel readline-devel gcc bison flex perl libconfig-devel kernel-devel rsync -y
yum install zlib jzlib zlib-devel -y
yum install wget -y
yum install libmemcached libmemcached-devel memcached.x86_64 memcached-devel libpqxx -y 
systemctl enable memcached
systemctl start memcached

#REPEAT CONFIGURATION FOR OTHER MACHINES

#GET SFW DATABASE POSTGRES
wget https://ftp.postgresql.org/pub/source/$VERSION/postgresql-$VERSION.tar.gz
tar xvfz postgresql-$VERSION.tar.gz
cd postgresql-$VERSION

#INSTALL SFW DATABASE POSTGRES
## install in default path /usr/local/pgsql using port 5432
./configure --with-openssl
example [./configure --prefix=$path/pgsql-$VERSION --with-openssl]
make
make install
cd contrib/
make
make install
ls -l /usr/local/pgsql/

#REPEAT CONFIGURATION FOR OTHER MACHINES

#CREATE USER AND DIRECTORY
adduser postgres
passwd postgres
mkdir -p /dados/data
mkdir -p /postgres/wals
chown postgres:postgres -R /dados
chown postgres:postgres -R /postgres

#REPEAT CONFIGURATION FOR OTHER MACHINES

su - postgres
/usr/local/pgsql-11.4/bin/initdb --locale=pt_BR.UTF-8 -D /dados/data/

#CONFIGURE ONLY ON PRIMARY

#CREATE SERVICE POSTGRESQL
vi /usr/lib/systemd/system/postgresql.service
[Unit]
Description=PostgreSQL database server
Documentation=man:postgres(1)

[Service]
Type=notify
User=postgres
ExecStart=/usr/local/pgsql-11.4/bin/postgres -D /dados/data
ExecReload=/bin/kill -HUP $MAINPID
KillMode=mixed
KillSignal=SIGINT
TimeoutSec=0

[Install]
WantedBy=multi-user.target

systemctl daemon-reload
systemctl enable postgresql.service
systemctl status postgresql.service
systemctl start postgresql.service

#REPEAT CONFIGURATION FOR OTHER MACHINES

#INSTALL SFW DATABASE PGPOOL
yum install -y https://www.pgpool.net/yum/rpms/4.1/redhat/rhel-7-x86_64/pgpool-II-release-4.1-2.noarch.rpm
yum install -y pgpool-II-pg11*

#REPEAT CONFIGURATION FOR OTHER MACHINES

#CONFIGURE POSTGRES PRIMARY
vi /dados/data/postgresql.conf
listen_addresses = '*'
port = 5432
wal_level = replica
archive_mode = on
archive_command = 'gzip -c %p > /postgres/wals/%f.gz'
archive_timeout = 600
max_wal_senders = 10
wal_keep_segments = 32
hot_standby = on
wal_log_hints = on 

systemctl stop postgresql.service
systemctl start postgresql.service

#CREATE USER FOR REPLICATION PRIMARY
su - postgtres
/usr/local/pgsql-11.4/bin/psql -U postgres -p 5432
SET password_encryption = 'scram-sha-256';
CREATE ROLE pgpool WITH LOGIN;
CREATE ROLE repl WITH REPLICATION LOGIN;
\password pgpool
\password repl
\password postgres
GRANT pg_monitor TO pgpool;
\q
exit

#CONFIGURE PG_HBA PRIMARY

vi /dados/data/pg_hba.conf
host    all             all             192.168.1.0/24          scram-sha-256
host    replication     all             192.168.1.0/24          scram-sha-256
su - postgres -c "/usr/local/pgsql-11.4/bin/pg_ctl reload -D /dados/data"

#TO PERFORM THE AUTOMATIVE FAILOVER IT IS NECESSARY TO EXCHANGE SSH KEYS USER ROOT AND POSTGRES USER
ssh-keygen -t rsa
cd .ssh/
ssh-copy-id -i id_rsa.pub root@192.168.1.126
ssh-copy-id -i id_rsa.pub root@192.168.1.127
ssh-copy-id -i id_rsa.pub root@192.168.1.128
ssh-copy-id -i id_rsa.pub postgres@192.168.1.126
ssh-copy-id -i id_rsa.pub postgres@192.168.1.127
ssh-copy-id -i id_rsa.pub postgres@192.168.1.128
su - postgres
ssh-keygen -t rsa
.ssh/
ssh-copy-id -i id_rsa.pub postgres@192.168.1.126
ssh-copy-id -i id_rsa.pub postgres@192.168.1.127
ssh-copy-id -i id_rsa.pub postgres@192.168.1.128

#CONFIGURE .PGPASS FILE
vi /dados/.pgpass
pgpool2_prim:5432:replication:repl:<repl user password>
pgpool2_stdb1:5432:replication:repl:<repl user passowrd>
pgpool2_stdb2:5432:replication:repl:<repl user passowrd>
pgpool2_prim:5432:postgres:postgres:<postgres user passowrd>
pgpool2_stdb1:5432:postgres:postgres:<postgres user passowrd>
pgpool2_stdb2:5432:postgres:postgres:<postgres user passowrd>
chmod 600 /dados/.pgpass

#REPEAT CONFIGURATION FOR OTHER MACHINES






















