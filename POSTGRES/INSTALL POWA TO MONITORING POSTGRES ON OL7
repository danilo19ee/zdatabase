++++++++++++++++++++++++++++++++++++++++++++++++++
+   INSTALL POWA TO MONITORING POSTGRES ON OL7   +
++++++++++++++++++++++++++++++++++++++++++++++++++

#PRE-REQUIRES
yum install -y python-pip python-devel python-psycopg2 git

#INSTALL
pip install --upgrade pip
pip install powa-web
pip install powa-collector

#DOWNLOAD AND UPDATE POSTGRES EXTENSIONS
wget https://github.com/powa-team/powa-archivist/archive/REL_4_0_0.tar.gz
tar xvfz REL_4_0_0.tar.gz
cd powa-archivist-REL_4_0_0
vi Makefile
cp powa.so /usr/local/pgsql-<$version>/lib/
cp powa.control powa.c powa--4.0.0.sql powa--3.2.0.sql powa--3.1.2--3.2.0.sql powa--3.1.1--3.1.2.sql powa--3.1.0--3.1.1.sql /usr/local/pgsql-<$version>/share/extension/

wget https://github.com/powa-team/pg_qualstats/archive/2.0.2.tar.gz
tar xvfz 2.0.2.tar.gz
cd pg_qualstats-2.0.2
vi Makefile
PG_CONFIG ?= /usr/local/pgsql-<$version>/bin/pg_config
make
cp pg_qualstats.so /usr/local/pgsql-<$version>/lib/
cp pg_qualstats.control pg_qualstats.c pg_qualstats--2.0.2.sql /usr/local/pgsql-<$version>/share/extension/

wget https://github.com/powa-team/pg_stat_kcache/archive/REL2_1_1.tar.gz
tar xvfz REL2_1_1.tar.gz
cd pg_stat_kcache-REL2_1_1
vi Makefile
PG_CONFIG ?= /usr/local/pgsql-<$version>/bin/pg_config
make
cp pg_stat_kcache.so /usr/local/pgsql-<$version>/lib/
cp pg_stat_kcache.control pg_stat_kcache.c pg_stat_kcache--2.1.1.sql pg_stat_kcache--2.1.0.sql pg_stat_kcache--2.1.0--2.1.1.sql /usr/local/pgsql-<$version>/share/extension/

wget https://download.postgresql.org/pub/repos/yum/<$version>/<$DISTRIBUITION>/<$SO>/pg_wait_sampling_<$version>.1.1-1.<$SO>.x86_64.rpm
rpm2cpio pg_wait_sampling_<$version>.1.1-1.<$SO>.x86_64.rpm | cpio -idmv
cp usr/pgsql-<$version>/lib/pg_wait_sampling.so /usr/local/pgsql-<$version>/lib/
cp usr/pgsql-<$version>/share/extension/pg_wait_sampling* /usr/local/pgsql-<$version>/share/extension/

wget https://github.com/HypoPG/hypopg/archive/master.zip
mv master.zip hypopg.zip
unzip hypopg.zip
cd hypopg
vi Makefile
PG_CONFIG ?= /usr/local/pgsql-<$version>/bin/pg_config
make
cp hypopg.so /usr/local/pgsql-<$version>/lib/
cp hypopg.control hypopg--2.0.0beta.sql hypopg--1.1.2.sql /usr/local/pgsql-<$version>/share/extension/

wget https://github.com/rjuju/pg_track_settings/archive/2.0.0.tar.gz -O pg_track_settings-2.0.0.tar.gz
tar xvfz pg_track_settings-2.0.0.tar.gz
cd pg_track_settings-2.0.0
cp pg_track_settings.control pg_track_settings--2.0.0.sql pg_track_settings--1.1.0.sql pg_track_settings--1.0.1.sql pg_track_settings--1.0.1--1.1.0.sql pg_track_settings--1.0.0.sql pg_track_settings--1.0.0--1.0.1.sql /usr/local/pgsql-<$version>/share/extension/

#DATABASE SETUP
su - postgres
vi /dados/data/postgresql.conf
listen_addresses = '*'
port = 5432
shared_preload_libraries='pg_stat_statements,powa,pg_stat_kcache,pg_qualstats,pg_wait_sampling'
track_io_timing = on
pg_qualstats.sample_rate = 1
#------------------------------------------------------------------------------
# POWA MONITORING
# -----------------------------------------------------------------------------
powa.frequency = 2min
powa.retention = 1d
# -----------------------------------------------------------------------------

#CREATE DATABASE POWA
/usr/local/pgsql-<$version>/bin/psql -U postgres
CREATE ROLE powa SUPERUSER LOGIN PASSWORD '************';
CREATE DATABASE IF NOT EXISTS powa;
\c powa
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
CREATE EXTENSION IF NOT EXISTS btree_gist;
CREATE EXTENSION IF NOT EXISTS powa;
CREATE EXTENSION IF NOT EXISTS pg_qualstats;
CREATE EXTENSION IF NOT EXISTS pg_stat_kcache;
CREATE EXTENSION IF NOT EXISTS pg_wait_sampling;
CREATE EXTENSION IF NOT EXISTS hypopg;
CREATE EXTENSION IF NOT EXISTS pg_track_settings;
\q
exit

#THE POWA-ARCHIVIST COLLECTS DATA FROM VARIOUS STATS EXTENSIONS
    pg_stat_statements
    pg_qualstats
    pg_stat_kcache
    pg_wait_sampling
    pg_track_settings
#ALL THOSE EXTENSIONS HAVE TO BE INSTALLED ON THE DEDICATED DATABASE OF THE MONITORED SERVER.

#PG_STAT_KCACHE
IS A POSTGRESQL EXTENSION GATHERING STATISTICS ON SYSTEM METRICS
CPU (USER TIME AND SYSTEM TIME)
PHYSICAL DISK ACCESS (READ AND WRITE)

HIT RATIO
SHARED BUFFER HIT RATIO: PERCENT OF BLOCKS READ FROM SHARED BUFFER (MEMORY)
SYSTEM CACHE HIT RATIO: PERCENT OF BLOCKS READ FROM THE SYSTEM CACHE (MEMORY)
DISK HIT RATIO: PERCENTAGE OF BLOCKS WHICH NEEDED A PHYSICAL DISK READ
TO ENABLE THIS EXTENSION DO

/usr/local/pgsql-<$version>/bin/psql -U postgres -d powa
select powa_kcache_register();
\q

#PG_STAT_STATEMENTS
THE PG_STAT_STATEMENTS EXTENSION RECORDS STATITSTICS OF ALL SQL QUERIES (AKA "statements”) EXECUTED ON A GIVEN PostgreSQL SERVER.

#CONFIGURATION FILES
vi /etc/powa-web.conf 
servers={
  'main': {
    'host': 'pg_primary',
    'port': '5432',
    'database': 'powa'
  }
}
cookie_secret="*********"

vi /etc/powa-collector.conf
{
    "repository": {
        "dsn": "postgresql://postgres@pg_primary:5432/powa"
    },
    "debug": false
}

#RUN POWA
nohup /usr/bin/powa-web > /var/log/powa-web.log 2>&1 & 
nohup /usr/bin/powa-collector.py > /var/log/powa-collector 2>&1 & 

#ACCESS WEB
http://ip:8888

********************************************************************************************************************************************************************************

#HOW TO MONITORING ANOTHER PRIMARY HOST DATABASE

#PRE-REQUIRES
yum install -y python-pip python-devel python-psycopg2

#INSTALL
pip install --upgrade pip
pip install powa-web
pip install powa-collector

#DOWNLOAD AND UPDATE POSTGRES EXTENSIONS

#DATABASE SETUP
su - postgres 
vi /dados/data/postgresql.conf
listen_addresses = '*'
port = 5432
shared_preload_libraries='pg_stat_statements,powa,pg_stat_kcache,pg_qualstats,pg_wait_sampling'
track_io_timing = on
pg_qualstats.sample_rate = 1
#------------------------------------------------------------------------------
# POWA MONITORING
# -----------------------------------------------------------------------------
powa.frequency = 2min
powa.retention = 1d
# -----------------------------------------------------------------------------

/usr/local/<$version>/bin/psql -U postgres
CREATE ROLE powa SUPERUSER LOGIN PASSWORD '************';
CREATE DATABASE powa;	
\c powa
create extension btree_gist;
create extension powa;
create extension hypopg;            
create extension pg_qualstats;      
create extension pg_stat_statements;
create extension pg_stat_kcache;   
create extension pg_track_settings; 
create extension pg_wait_sampling; 
create extension plpgsql;           

\c <other databases>
create extension hypopg;            
create extension pg_qualstats;      
create extension pg_stat_statements;
create extension pg_stat_kcache;    
create extension pg_track_settings; 
create extension pg_wait_sampling; 
\q
exit

#GRANT CONNECT NO SERVER COLLECTOR
vi /dados/data/pg_hba.conf
host    all      powa            <$remote_server>/32         md5

/usr/local/<$version>/bin/pg_ctl reload -D /dados-prim/data/"

#REGISTER DATABASE ON REMOTE SERVER COLLECTOR

##PARAMETES##
(hostname text, port integer DEFAULT 5432, alias text DEFAULT NULL::text, username text DEFAULT 'powa'::text, password text DEFAULT NULL::text, dbname text DEFAULT 'powa'::text, frequency integer DEFAULT 300, powa_coalesce integer DEFAULT 100, retention interval DEFAULT '1 day'::interval, allow_ui_connection boolean DEFAULT true, extensions text[] DEFAULT NULL::text[])

/usr/local/<$version>/bin/psql -U postgres -d powa
SELECT powa_register_server(hostname 'pg_prim-stdb', 
port => 5432, 
alias 'example-prim'::text, 
username => 'powa'::text, 
password => '************'::text, 
dbname => 'powa'::text, 
frequency => 120, 
powa_coalesce => 100, 
retention => '00:00:00'::interval, 
allow_ui_connection => true, 
extensions => '{pg_stat_kcache,pg_qualstats,pg_wait_sampling}');    
select * from powa_servers;
SELECT powa_wait_sampling_register(<$ID>);
select public.powa_activate_extension(<$ID>, 'pg_track_settings');

#REMOVE REMOTE SERVER 	
/usr/local/<$version>/bin/psql -U postgres -d powa
select * from powa_servers;
SELECT powa_delete_and_purge_server(<$ID>);

#FORCE TAKE SNAPSHOT WAINT AND RUN AGAIN (THE TOOL NEEDS TWO SNAPSHOTS TO DISPLAY BREAK DATA)
select * from powa_servers;
select public.powa_take_snapshot(<$ID>);
select public.powa_take_snapshot(<$ID>);


********************************************************************************************************************************************************************************

#HOW TO MONITORING ANOTHER STANDBY HOST DATABASE


